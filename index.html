<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KS Healthcare Commission Reports</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: #f9faff;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    input[type=file] {
      display: block;
      margin-bottom: 1rem;
    }
    .buttons {
      margin: 20px 0;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button {
      padding: 12px 18px;
      background-color: #005bbb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background-color: #7a8fa4;
      cursor: default;
    }
    button:hover:not(:disabled) {
      background-color: #004a95;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 12px;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background-color: #005bbb;
      color: white;
      font-weight: 600;
      text-transform: uppercase;
    }
    tfoot td {
      font-weight: 700;
      background-color: #f0f4f8;
    }
    .downloads {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .downloads button {
      background-color: #2a9d8f;
    }
    .downloads button:hover {
      background-color: #20806f;
    }
  </style>
</head>
<body>
  <h1>KS Healthcare Commission Reports</h1>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />

  <div class="buttons">
    <button id="reportRahman" disabled>Generate Dr. M.F. Rahman Report</button>
    <button id="reportAkhter" disabled>Generate Dr. Md. Akhter Reza Report</button>
    <button id="reportDebashish" disabled>Generate Dr. DEBASHISH CHAKRABORTY Report</button>
  </div>

  <div id="reportArea"></div>

  <div class="downloads" id="downloadArea" style="display:none;">
    <button id="downloadExcel">Download Excel</button>
    <button id="downloadPDF">Download PDF</button>
  </div>

  <!-- SheetJS to read and write Excel files -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF to create PDF files -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    (function () {
      const fileInput = document.getElementById('fileInput');
      const btnRahman = document.getElementById('reportRahman');
      const btnAkhter = document.getElementById('reportAkhter');
      const btnDebashish = document.getElementById('reportDebashish');
      const reportArea = document.getElementById('reportArea');
      const downloadArea = document.getElementById('downloadArea');
      const downloadExcelBtn = document.getElementById('downloadExcel');
      const downloadPDFBtn = document.getElementById('downloadPDF');

      let rawData = null;
      let fileName = '';
      let currentReportData = null;
      let currentReportTitle = '';

      // Function to read Excel and load data
      function handleFile(e) {
        const f = e.target.files[0];
        if (!f) return resetApp();

        fileName = f.name;

        const reader = new FileReader();

        reader.onload = function (evt) {
          const data = evt.target.result;
          // Read Excel workbook
          const workbook = XLSX.read(data, { type: 'binary' });

          // Assuming first sheet has the data
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];

          // Convert to JSON with raw values
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

          // Basic validation of columns
          if (!jsonData.length) {
            alert('Uploaded Excel file is empty.');
            resetApp();
            return;
          }
          const firstRow = jsonData[0];
          const requiredCols = [
            "Sr.No.",
            "Date",
            "Corporate",
            "Patient Name",
            "Test Performed",
            "Ref.Dr",
            "Net"
          ];
          for (const col of requiredCols) {
            if (!(col in firstRow)) {
              alert(`Missing required column "${col}" in Excel file.`);
              resetApp();
              return;
            }
          }

          // Save data globally
          rawData = jsonData;

          // Enable buttons
          btnRahman.disabled = false;
          btnAkhter.disabled = false;
          btnDebashish.disabled = false;

          // Clear previous report
          reportArea.innerHTML = '';
          downloadArea.style.display = 'none';
        };

        reader.readAsBinaryString(f);
      }

      fileInput.addEventListener('change', handleFile);

      // Utility: round numbers
      function roundAmount(val) {
        return Math.round(Number(val) || 0);
      }

      // Build Table HTML given an array of objects and columns
      function buildTable(data, columns) {
        let html = '<table><thead><tr>';
        for (const col of columns) {
          html += `<th>${col}</th>`;
        }
        html += '</tr></thead><tbody>';
        data.forEach(row => {
          html += '<tr>';
          for (const col of columns) {
            html += `<td>${row[col]}</td>`;
          }
          html += '</tr>';
        });
        html += '</tbody><tfoot><tr>';
        for(let i = 0; i < columns.length - 1; i++) {
          html += '<td></td>';
        }
        html += `<td><strong>${data.length > 0 ? data[data.length - 1][columns[columns.length-1]] : ''}</strong></td>`;
        html += '</tr></tfoot></table>';
        return html;
      }

      // Generate report data for given doctor with commission rate and amount calculation
      function generateReport(refDrName, commissionFn) {
        if (!rawData) {
          alert('Please upload a valid Excel file first.');
          return;
        }

        // Filter data by Ref.Dr
        let filtered = rawData.filter(r => r['Ref.Dr'].toString().trim().toUpperCase() === refDrName.toUpperCase());
        if (!filtered.length) {
          alert(`No records found for ${refDrName}`);
          reportArea.innerHTML = '';
          downloadArea.style.display = 'none';
          return;
        }

        // Prepare data for report
        let reportData = [];
        let totalAmount = 0;

        for(let i = 0; i < filtered.length; i++) {
          let r = filtered[i];
          const netVal = Number(r['Net']) || 0;
          let amount = commissionFn(netVal);
          amount = roundAmount(amount);
          totalAmount += amount;

          reportData.push({
            "Sr.No.": r["Sr.No."],
            "Date": r["Date"],
            "Patient Name": r["Patient Name"],
            "Test Performed": r["Test Performed"],
            "Amount": amount
          });
        }
        totalAmount = roundAmount(totalAmount);

        // Add total row at the end (Amount column)
        reportData.push({
          "Sr.No.": '',
          "Date": '',
          "Patient Name": '',
          "Test Performed": 'Total',
          "Amount": totalAmount
        });

        currentReportData = reportData;
        currentReportTitle = `KS Healthcare report - ${fileName.replace(/\.[^/.]+$/, '')}`;

        // Render table
        const columns = ["Sr.No.", "Date", "Patient Name", "Test Performed", "Amount"];
        reportArea.innerHTML = buildTable(reportData, columns);
        downloadArea.style.display = 'flex';
      }

      // Button handlers with respective commissions
      btnRahman.addEventListener('click', () => {
        generateReport('Dr. M.F. Rahman', net => net * 0.30);
      });

      btnAkhter.addEventListener('click', () => {
        generateReport('Dr. Md. Akhter Reza', net => net);
      });

      btnDebashish.addEventListener('click', () => {
        generateReport('Dr. DEBASHISH CHAKRABORTY', net => net * 0.35);
      });

      // Download Excel
      downloadExcelBtn.addEventListener('click', () => {
        if (!currentReportData) return;

        const wb = XLSX.utils.book_new();
        const wsData = [];

        // Prepare header row
        const header = Object.keys(currentReportData[0]);
        wsData.push(header);

        // Prepare data rows
        for (const row of currentReportData) {
          wsData.push(header.map(h => row[h]));
        }

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Report');

        XLSX.writeFile(wb, `${currentReportTitle}.xlsx`);
      });

      // Download PDF
      downloadPDFBtn.addEventListener('click', () => {
        if (!currentReportData) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(16);
        doc.text(currentReportTitle, 14, 20);

        // Prepare data for AutoTable
        const columns = Object.keys(currentReportData[0]).map(h => ({ header: h, dataKey: h }));

        // Remove 'Commission Rate' and 'Generated' if they appear in data - per requirement, but they do not appear in report, so no extra cleaning needed.

        // AutoTable consumes array of objects and columns with keys

        // Start table below title
        doc.autoTable({
          startY: 28,
          head: [columns.map(c => c.header)],
          body: currentReportData.map(row => columns.map(c => row[c.dataKey])),
          styles: { halign: 'center' },
          headStyles: { fillColor: [0, 91, 187], textColor: 255, fontStyle: 'bold' },
          footStyles: { fillColor: [224, 244, 248], fontStyle: 'bold' },
          didDrawPage: function (data) {
            // Optionally can add footer or page numbers if needed
          }
        });

        doc.save(`${currentReportTitle}.pdf`);
      });

      // Reset app on invalid
      function resetApp() {
        rawData = null;
        fileName = '';
        currentReportData = null;
        currentReportTitle = '';

        btnRahman.disabled = true;
        btnAkhter.disabled = true;
        btnDebashish.disabled = true;
        reportArea.innerHTML = '';
        downloadArea.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
